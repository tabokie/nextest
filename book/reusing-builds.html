<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Archiving and reusing builds - cargo-nextest</title>


        <!-- Custom HTML head -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta property="og:title" content="Archiving and reusing builds - cargo-nextest" />
        <meta property="og:image" content="https://nexte.st/static/cover.png" />
        <meta property="og:description" content="A next-generation test runner for Rust." />

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A next-generation test runner for Rust.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../css/extra.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Home</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../book/installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/pre-built-binaries.html"><strong aria-hidden="true">1.1.</strong> Pre-built binaries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/release-urls.html"><strong aria-hidden="true">1.1.1.</strong> Release URLs</a></li></ol></li><li class="chapter-item expanded "><a href="../book/installing-from-source.html"><strong aria-hidden="true">1.2.</strong> Installing from source</a></li><li class="chapter-item expanded "><a href="../book/antivirus-gatekeeper.html"><strong aria-hidden="true">1.3.</strong> Windows antivirus and macOS Gatekeeper</a></li></ol></li><li class="chapter-item expanded "><a href="../book/usage.html"><strong aria-hidden="true">2.</strong> Usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/running.html"><strong aria-hidden="true">2.1.</strong> Running tests</a></li><li class="chapter-item expanded "><a href="../book/listing.html"><strong aria-hidden="true">2.2.</strong> Listing tests</a></li><li class="chapter-item expanded "><a href="../book/retries.html"><strong aria-hidden="true">2.3.</strong> Retries and flaky tests</a></li><li class="chapter-item expanded "><a href="../book/reusing-builds.html" class="active"><strong aria-hidden="true">2.4.</strong> Archiving and reusing builds</a></li><li class="chapter-item expanded "><a href="../book/partitioning.html"><strong aria-hidden="true">2.5.</strong> Partitioning test runs in CI</a></li><li class="chapter-item expanded "><a href="../book/target-runners.html"><strong aria-hidden="true">2.6.</strong> Target runners</a></li><li class="chapter-item expanded "><a href="../book/other-options.html"><strong aria-hidden="true">2.7.</strong> Other options</a></li><li class="chapter-item expanded "><a href="../book/env-vars.html"><strong aria-hidden="true">2.8.</strong> Environment variables</a></li></ol></li><li class="chapter-item expanded "><a href="../book/machine-readable.html"><strong aria-hidden="true">3.</strong> Machine-readable output</a></li><li class="chapter-item expanded "><a href="../book/configuration.html"><strong aria-hidden="true">4.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../book/junit.html"><strong aria-hidden="true">5.</strong> JUnit support</a></li><li class="chapter-item expanded "><a href="../book/test-coverage.html"><strong aria-hidden="true">6.</strong> Test coverage</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../book/stability.html"><strong aria-hidden="true">7.</strong> Stability policy</a></li><li class="chapter-item expanded "><a href="../book/experimental-features.html"><strong aria-hidden="true">8.</strong> Experimental features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/filter-expressions.html"><strong aria-hidden="true">8.1.</strong> Filter expressions</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../book/how-it-works.html"><strong aria-hidden="true">9.</strong> How nextest works</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../book/benchmarks.html"><strong aria-hidden="true">9.1.</strong> Benchmarks</a></li><li class="chapter-item expanded "><a href="../book/custom-test-harnesses.html"><strong aria-hidden="true">9.2.</strong> Custom test harnesses</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../CHANGELOG.html">Changelog</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">cargo-nextest</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/nextest-rs/nextest" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/nextest-rs/nextest/edit/main/site/src/book/reusing-builds.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="archiving-and-reusing-builds"><a class="header" href="#archiving-and-reusing-builds">Archiving and reusing builds</a></h1>
<p>In some cases, it can be useful to separate out building tests from running them. Nextest supports archiving builds on one machine, and then extracting the archive to run tests on another machine.</p>
<h2 id="terms"><a class="header" href="#terms">Terms</a></h2>
<ul>
<li><strong>Build machine:</strong> The computer that builds tests.</li>
<li><strong>Target machine:</strong> The computer that runs tests.</li>
</ul>
<h2 id="use-cases"><a class="header" href="#use-cases">Use cases</a></h2>
<ul>
<li><strong>Cross-compilation.</strong> The build machine has a different architecture, or runs a different operating system, from the target machine.</li>
<li><strong>Test partitioning.</strong> Build once on the build machine, then <a href="partitioning.html">partition test execution</a> across multiple target machines.</li>
<li><strong>Saving execution time on more valuable machines.</strong> For example, build tests on a regular machine, then run them on a machine with a GPU attached to it.</li>
</ul>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<ul>
<li><strong>The project source must be checked out to the same revision on the target machine.</strong> This might be needed for test fixtures and other assets, and nextest sets the right working directory relative to the workspace root when executing tests.</li>
<li><strong>It is your responsibility to transfer over the archive.</strong> Use the examples below as a template.</li>
<li><strong>Nextest must be installed on the target machine.</strong> For best results, use the same version of nextest on both machines.</li>
</ul>
<h3 id="non-requirements"><a class="header" href="#non-requirements">Non-requirements</a></h3>
<ul>
<li><strong>Cargo does not need to be installed on the target machine.</strong> If <code>cargo</code> is unavailable, replace <code>cargo nextest</code> with <code>cargo-nextest nextest</code> in the following examples.</li>
</ul>
<h2 id="creating-archives"><a class="header" href="#creating-archives">Creating archives</a></h2>
<p><code>cargo nextest archive --archive-file &lt;name-of-archive.tar.zst&gt;</code> creates an archive with the following contents:</p>
<ul>
<li>Cargo-related metadata, at the location <code>target/nextest/cargo-metadata.json</code>.</li>
<li>Metadata about test binaries, at the location <code>target/nextest/binaries-metadata.json</code>.</li>
<li>All test binaries</li>
<li>Other relevant files:
<ul>
<li>Dynamic libraries that test binaries might link to</li>
<li>Non-test binaries used by integration tests</li>
</ul>
</li>
</ul>
<p>Currently, the only format supported is a Zstandard-compressed tarball (<code>.tar.zst</code>).</p>
<h2 id="running-tests-from-archives"><a class="header" href="#running-tests-from-archives">Running tests from archives</a></h2>
<p><code>cargo nextest list</code> and <code>run</code> support a new <code>--archive-file</code> option. This option accepts archives created by <code>cargo nextest archive</code> as above.</p>
<p>By default, archives are extracted to a temporary directory, and nextest remaps paths to use the new
target directory. To specify the directory archives should be extracted to, use the <code>--extract-to</code>
option.</p>
<p><strong>Note that archives do not include the source code for your project.</strong> It is your responsibility to ensure that the source code for your project is transferred over to the target machine.</p>
<h3 id="specifying-a-new-location-for-the-source-code"><a class="header" href="#specifying-a-new-location-for-the-source-code">Specifying a new location for the source code</a></h3>
<p>By default, nextest expects the workspace's source code to be in the same location on both the build and target machines. To specify a new location for the workspace, use the <code>--workspace-remap &lt;path-to-workspace-root&gt;</code> option with the <code>list</code> or <code>run</code> commands.</p>
<h2 id="example-simple-buildrun-split"><a class="header" href="#example-simple-buildrun-split">Example: Simple build/run split</a></h2>
<ol>
<li>Build and archive tests:
<pre><code>cargo nextest archive --archive-file my-archive.tar.zst
</code></pre>
</li>
<li>Run the tests:
<pre><code>cargo nextest run --archive-file my-archive.tar.zst
</code></pre>
</li>
</ol>
<h2 id="example-use-in-github-actions"><a class="header" href="#example-use-in-github-actions">Example: Use in GitHub Actions</a></h2>
<p>See <a href="https://github.com/nextest-rs/reuse-build-partition-example/blob/main/.github/workflows/ci.yml">this working example</a> for how to reuse builds and <a href="partitioning.html">partition test runs</a> on GitHub Actions.</p>
<h2 id="example-cross-compilation"><a class="header" href="#example-cross-compilation">Example: Cross-compilation</a></h2>
<p>While cross-compiling code, some tests may need to be run on the host platform. (See the note about <a href="running.html#filtering-by-build-platform">Filtering by build platform</a> for more.)</p>
<h3 id="on-the-build-machine"><a class="header" href="#on-the-build-machine">On the build machine</a></h3>
<ol>
<li>Build and run host-only tests:
<pre><code>cargo nextest run --target &lt;TARGET&gt; --platform-filter host
</code></pre>
</li>
<li>Archive tests:
<pre><code>cargo nextest archive --target &lt;TARGET&gt; --archive-file my-archive.tar.zst
</code></pre>
</li>
<li>Copy <code>my-archive.tar.zst</code> to the target machine.</li>
</ol>
<h3 id="on-the-target-machine"><a class="header" href="#on-the-target-machine">On the target machine</a></h3>
<ol>
<li>Check out the project repository to a path <code>&lt;REPO-PATH&gt;</code>, to the same revision as the build machine.</li>
<li>List target-only tests:
<pre><code>cargo nextest list --platform-filter target \
    --archive-file my-archive.tar.zst \
    --workspace-remap &lt;REPO-PATH&gt;
</code></pre>
</li>
<li>Run target-only tests:
<pre><code>cargo nextest run --platform-filter target \
    --archive-file my-archive.tar.zst \
    --workspace-remap &lt;REPO-PATH&gt;
</code></pre>
</li>
</ol>
<h2 id="manually-creating-your-own-archives"><a class="header" href="#manually-creating-your-own-archives">Manually creating your own archives</a></h2>
<p>You can also create and manage your own archives, with the following options to <code>cargo nextest list</code> and <code>run</code>:</p>
<ul>
<li><code>--binaries-metadata</code>: The path to JSON metadata generated by <code>cargo nextest list --list-type binaries-only --message-format json</code>.</li>
<li><code>--target-dir-remap</code>: A possible new location for the target directory. Requires <code>--binaries-metadata</code>.</li>
<li><code>--cargo-metadata</code>: The path to JSON metadata generated by <code>cargo metadata --format-version 1</code>.</li>
</ul>
<h2 id="making-tests-relocatable"><a class="header" href="#making-tests-relocatable">Making tests relocatable</a></h2>
<p>Some tests may need to be modified to handle changes in the workspace and target directories. Some common situations:</p>
<ul>
<li>
<p>To obtain the path to the source directory, Cargo provides the <code>CARGO_MANIFEST_DIR</code> option at both build time and runtime. For relocatable tests, use the value of <code>CARGO_MANIFEST_DIR</code> at runtime. This means <code>std::env::var(&quot;CARGO_MANIFEST_DIR&quot;)</code>, not <code>env!(&quot;CARGO_MANIFEST_DIR&quot;)</code>.</p>
<p>If the workspace is remapped, nextest automatically sets <code>CARGO_MANIFEST_DIR</code> to the new location.</p>
</li>
<li>
<p>To obtain the path to a crate's executables, Cargo provides the <a href="https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-sets-for-crates"><code>CARGO_BIN_EXE_&lt;name&gt;</code></a> option to integration tests at build time. To handle target directory remapping, use the value of <code>NEXTEST_BIN_EXE_&lt;name&gt;</code> at runtime.</p>
<p>To retain compatibility with <code>cargo test</code>, you can fall back to the value of <code>CARGO_BIN_EXE_&lt;name&gt;</code> at build time.</p>
</li>
</ul>
<h2 id="options-and-arguments-for-cargo-nextest-archive"><a class="header" href="#options-and-arguments-for-cargo-nextest-archive">Options and arguments for <code>cargo nextest archive</code></a></h2>
<pre><code>cargo-nextest-archive 
Build and archive tests

USAGE:
    cargo nextest archive [OPTIONS] --archive-file &lt;PATH&gt;

OPTIONS:
        --manifest-path &lt;PATH&gt;    Path to Cargo.toml
    -v, --verbose                 Verbose output [env: NEXTEST_VERBOSE=]
        --color &lt;WHEN&gt;            Produce color output: auto, always, never [env: CARGO_TERM_COLOR=]
                                  [default: auto]
        --config-file &lt;PATH&gt;      Config file [default: workspace-root/.config/nextest.toml]
    -h, --help                    Print help information

CARGO OPTIONS:
        --lib                       Test only this package's library unit tests
        --bin &lt;BIN&gt;                 Test only the specified binary
        --bins                      Test all binaries
        --test &lt;TEST&gt;               Test only the specified test target
        --tests                     Test all targets
        --bench &lt;BENCH&gt;             Test only the specified bench target
        --benches                   Test all benches
        --all-targets               Test all targets
    -p, --package &lt;PACKAGES&gt;        Package to test
        --workspace                 Build all packages in the workspace
        --exclude &lt;EXCLUDE&gt;         Exclude packages from the test
        --all                       Alias for workspace (deprecated)
    -r, --release                   Build artifacts in release mode, with optimizations
        --cargo-profile &lt;NAME&gt;      Build artifacts with the specified Cargo profile
        --build-jobs &lt;JOBS&gt;         Number of build jobs to run
        --features &lt;FEATURES&gt;       Space or comma separated list of features to activate
        --all-features              Activate all available features
        --no-default-features       Do not activate the `default` feature
        --target &lt;TRIPLE&gt;           Build for the target triple
        --target-dir &lt;DIR&gt;          Directory for all generated artifacts
        --ignore-rust-version       Ignore `rust-version` specification in packages
        --unit-graph                Output build graph in JSON (unstable)
        --future-incompat-report    Outputs a future incompatibility report at the end of the build
        --frozen                    Require Cargo.lock and cache are up to date
        --locked                    Require Cargo.lock is up to date
        --offline                   Run without accessing the network
        --config &lt;KEY=VALUE&gt;        Override a configuration value (unstable)
    -Z &lt;FLAG&gt;                       Unstable (nightly-only) flags to Cargo, see 'cargo -Z help'
                                    for details

ARCHIVE OPTIONS:
        --archive-file &lt;PATH&gt;        File to write archive to
        --archive-format &lt;FORMAT&gt;    Archive format [default: auto] [possible values: auto, tar-zst]
        --zstd-level &lt;LEVEL&gt;         Zstandard compression level (-7 to 22, higher is more
                                     compressed + slower) [default: 0]
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../book/retries.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../book/partitioning.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../book/retries.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../book/partitioning.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
